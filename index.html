<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ—…è¡Œè§„åˆ’å¸ˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            background-color: #2c3e50;
            color: white;
            padding: 20px 0;
            text-align: center;
        }
        .main-content {
            background-color: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .input-section {
            margin-bottom: 30px;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .voice-button {
            background-color: #2ecc71;
            margin-left: 10px;
        }
        .voice-button:hover {
            background-color: #27ae60;
        }
        .plan-result {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .api-config {
            background-color: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
        }
        .budget-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #ddd;
        }
        .map-container {
            width: 100%;
            height: 400px;
            background-color: #eee;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <header>
        <h1>AI æ—…è¡Œè§„åˆ’å¸ˆ</h1>
        <p>æ™ºèƒ½è§„åˆ’æ‚¨çš„å®Œç¾æ—…ç¨‹</p>
    </header>

    <div class="container">
        <div class="main-content">
            <!-- ç”¨æˆ·è®¤è¯ -->
            <div class="auth-section">
                <h2>ç”¨æˆ·ç™»å½•/æ³¨å†Œ</h2>
                <div class="form-group">
                    <label for="email">é‚®ç®±</label>
                    <input type="email" id="email" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <button id="loginBtn">ç™»å½•</button>
                <button id="registerBtn">æ³¨å†Œ</button>
            </div>

            <!-- è¡Œç¨‹è§„åˆ’è¾“å…¥ -->
            <div class="input-section">
                <h2>æ—…è¡Œéœ€æ±‚</h2>
                <div class="form-group">
                    <label for="destination">ç›®çš„åœ°</label>
                    <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šæ—¥æœ¬ä¸œäº¬">
                    <button class="voice-button" onclick="startVoiceRecognition('destination')">ğŸ¤ è¯­éŸ³è¾“å…¥</button>
                </div>
                <div class="form-group">
                    <label for="days">æ—…è¡Œå¤©æ•°</label>
                    <input type="number" id="days" placeholder="ä¾‹å¦‚ï¼š5">
                </div>
                <div class="form-group">
                    <label for="budget">é¢„ç®—ï¼ˆå…ƒï¼‰</label>
                    <input type="number" id="budget" placeholder="ä¾‹å¦‚ï¼š10000">
                </div>
                <div class="form-group">
                    <label for="travelers">åŒè¡Œäººæ•°</label>
                    <input type="number" id="travelers" placeholder="ä¾‹å¦‚ï¼š2">
                </div>
                <div class="form-group">
                    <label for="preferences">æ—…è¡Œåå¥½</label>
                    <textarea id="preferences" rows="3" placeholder="ä¾‹å¦‚ï¼šå–œæ¬¢ç¾é£Ÿã€åŠ¨æ¼«ï¼Œå¸¦å­©å­"></textarea>
                    <button class="voice-button" onclick="startVoiceRecognition('preferences')">ğŸ¤ è¯­éŸ³è¾“å…¥</button>
                </div>
                <button id="planBtn">ç”Ÿæˆæ—…è¡Œè®¡åˆ’</button>
            </div>

            <!-- è¡Œç¨‹ç»“æœ -->
            <div id="planResult" class="plan-result" style="display: none;">
                <h2>æ—…è¡Œè®¡åˆ’</h2>
                <div id="planContent"></div>
            </div>

            <!-- è´¹ç”¨é¢„ç®—ä¸ç®¡ç† -->
            <div class="expense-section">
                <h2>è´¹ç”¨é¢„ç®—ä¸ç®¡ç†</h2>
                
                <!-- è´¹ç”¨è®°å½•è¡¨å• -->
                <div class="expense-form" style="margin-bottom: 20px; padding: 15px; background-color: #f9f9f9; border-radius: 8px;">
                    <h3 style="margin-top: 0;">æ·»åŠ è´¹ç”¨è®°å½•</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label for="expenseCategory" style="display: block; margin-bottom: 5px;">ç±»åˆ«</label>
                            <select id="expenseCategory" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="é¤é¥®">é¤é¥®</option>
                                <option value="äº¤é€š">äº¤é€š</option>
                                <option value="ä½å®¿">ä½å®¿</option>
                                <option value="è´­ç‰©">è´­ç‰©</option>
                                <option value="æ™¯ç‚¹">æ™¯ç‚¹é—¨ç¥¨</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div>
                            <label for="expenseAmount" style="display: block; margin-bottom: 5px;">é‡‘é¢</label>
                            <input type="number" id="expenseAmount" placeholder="ä¾‹å¦‚ï¼š100" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                        <div>
                            <label for="expenseDate" style="display: block; margin-bottom: 5px;">æ—¥æœŸ</label>
                            <input type="date" id="expenseDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="expenseDescription" style="display: block; margin-bottom: 5px;">æè¿°</label>
                        <input type="text" id="expenseDescription" placeholder="ä¾‹å¦‚ï¼šåˆé¤ - å½“åœ°ç‰¹è‰²é¤å…" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button id="addExpenseBtn" style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            æ·»åŠ è´¹ç”¨
                        </button>
                        <button id="voiceExpenseBtn" style="padding: 8px 15px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-microphone"></i> è¯­éŸ³è¾“å…¥è´¹ç”¨
                        </button>
                    </div>
                    <div id="expenseMessage" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
                </div>
                
                <!-- è´¹ç”¨åˆ—è¡¨ä¸é¢„ç®—åˆ†æ -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <!-- è´¹ç”¨åˆ—è¡¨ -->
                    <div>
                        <h3>è´¹ç”¨è®°å½•åˆ—è¡¨</h3>
                        <div id="expenseList" class="expense-list" style="max-height: 400px; overflow-y: auto; padding: 10px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px;">
                            <p style="color: #666; text-align: center;">æš‚æ— è´¹ç”¨è®°å½•</p>
                        </div>
                    </div>
                    
                    <!-- é¢„ç®—åˆ†æ -->
                    <div>
                        <h3>é¢„ç®—åˆ†æ</h3>
                        <div id="budgetAnalysis" style="padding: 15px; background-color: #fff; border: 1px solid #ddd; border-radius: 8px;">
                            <div style="margin-bottom: 10px;">
                                <p><strong>æ€»é¢„ç®—ï¼š</strong><span id="totalBudget">0</span> å…ƒ</p>
                                <p><strong>å·²èŠ±è´¹ï¼š</strong><span id="totalExpenses">0</span> å…ƒ ( <span id="percentageUsed">0</span>% )</p>
                                <p><strong>å‰©ä½™é¢„ç®—ï¼š</strong><span id="remainingBudget">0</span> å…ƒ</p>
                                <p><strong>é¢„ç®—çŠ¶æ€ï¼š</strong><span id="budgetStatus" class="budget-status-sufficient">é¢„ç®—å……è¶³</span></p>
                            </div>
                            
                            <!-- é¢„ç®—è¿›åº¦æ¡ -->
                            <div style="height: 20px; background-color: #e0e0e0; border-radius: 10px; margin: 15px 0;">
                                <div id="budgetProgressBar" style="height: 100%; width: 0%; background-color: #4CAF50; transition: width 0.3s, background-color 0.3s;"></div>
                            </div>
                            
                            <!-- æ”¯å‡ºåˆ†ç±»ç»Ÿè®¡ -->
                            <div>
                                <h4>æ”¯å‡ºåˆ†ç±»</h4>
                                <div id="expenseCategories" style="display: flex; flex-wrap: wrap; gap: 10px;">
                                    <p style="color: #666;">æš‚æ— æ”¯å‡ºæ•°æ®</p>
                                </div>
                            </div>
                            
                            <!-- å»ºè®® -->
                            <div style="margin-top: 15px;">
                                <h4>é¢„ç®—å»ºè®®</h4>
                                <ul id="budgetRecommendations" style="list-style: none; padding: 0; margin: 0;">
                                    <li style="color: #666;">ç”Ÿæˆè¡Œç¨‹åå¯æŸ¥çœ‹é¢„ç®—å»ºè®®</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

            <!-- åœ°å›¾å±•ç¤º -->
            <div class="map-section">
                <h2>è¡Œç¨‹åœ°å›¾</h2>
                <div class="map-container" style="position: relative; width: 100%; height: 500px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9; overflow: hidden;">
                    <div id="map" style="width: 100%; height: 100%;"></div>
                    <div id="map-placeholder" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666;">
                        <i class="fas fa-map-marker-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>åœ°å›¾å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
                        <p style="margin-top: 10px; font-size: 14px;">è¯·å…ˆç”Ÿæˆè¡Œç¨‹è®¡åˆ’ï¼Œæˆ–åœ¨APIé…ç½®ä¸­è®¾ç½®åœ°å›¾æœåŠ¡</p>
                    </div>
                </div>
            </div>

            <!-- æœåŠ¡é…ç½®ç®¡ç† -->
            <div id="apiConfigSection" class="api-config">
                <h3>æœåŠ¡é…ç½®ç®¡ç†</h3>
                
                <!-- AI æ¨¡å‹é…ç½® -->
                <div class="config-section" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
                    <h4>AI æ¨¡å‹é…ç½®</h4>
                    <div style="margin-bottom: 10px;">
                        <label for="aiProvider">æœåŠ¡æä¾›å•†:</label>
                        <select id="aiProvider" style="margin-left: 10px; padding: 5px;">
                            <option value="mock">æ¨¡æ‹Ÿæ¨¡å‹ï¼ˆæ— éœ€ API Keyï¼‰</option>
                            <option value="openai">OpenAI</option>
                            <option value="aliyun">é˜¿é‡Œäº‘ç™¾ç‚¼</option>
                        </select>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label for="aiApiKey" style="display: inline-block; width: 100px;">API Key:</label>
                        <input type="password" id="aiApiKey" placeholder="è¯·è¾“å…¥ API Key" style="width: 300px; padding: 6px;">
                    </div>
                    <div id="openaiConfig" style="display: none; margin-bottom: 15px;">
                        <label for="openaiModel" style="display: inline-block; width: 100px;">æ¨¡å‹:</label>
                        <select id="openaiModel" style="padding: 5px;">
                            <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                            <option value="gpt-4">gpt-4</option>
                        </select>
                    </div>
                    <div id="aliyunConfig" style="display: none; margin-bottom: 15px;">
                        <label for="aliyunAppKey" style="display: inline-block; width: 100px;">App Key:</label>
                        <input type="password" id="aliyunAppKey" placeholder="è¯·è¾“å…¥é˜¿é‡Œäº‘ App Key" style="width: 300px; padding: 6px; margin-bottom: 10px;">
                        <div style="margin-left: 105px;">
                            <label for="aliyunModel">æ¨¡å‹:</label>
                            <select id="aliyunModel" style="padding: 5px;">
                                <option value="qwen-plus">qwen-plus</option>
                                <option value="qwen-max">qwen-max</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- è¯­éŸ³è¯†åˆ«é…ç½® -->
                <div class="config-section" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
                    <h4>è¯­éŸ³è¯†åˆ«é…ç½®</h4>
                    <div style="margin-bottom: 10px;">
                        <label for="voiceProvider">æœåŠ¡æä¾›å•†:</label>
                        <select id="voiceProvider" style="margin-left: 10px; padding: 5px;">
                            <option value="browser">æµè§ˆå™¨åŸç”Ÿï¼ˆæ— éœ€ API Keyï¼‰</option>
                            <option value="iflytek">ç§‘å¤§è®¯é£</option>
                        </select>
                    </div>
                    <div id="iflytekConfig" style="display: none; margin-bottom: 15px;">
                        <div style="margin-bottom: 10px;">
                            <label for="voiceApiKey" style="display: inline-block; width: 100px;">App ID:</label>
                            <input type="text" id="voiceApiKey" placeholder="è¯·è¾“å…¥ç§‘å¤§è®¯é£ App ID" style="width: 300px; padding: 6px;">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="voiceApiSecret" style="display: inline-block; width: 100px;">API Key:</label>
                            <input type="password" id="voiceApiSecret" placeholder="è¯·è¾“å…¥ç§‘å¤§è®¯é£ API Key" style="width: 300px; padding: 6px;">
                        </div>
                    </div>
                </div>
                
                <!-- åœ°å›¾æœåŠ¡é…ç½® -->
                <div class="config-section" style="margin-bottom: 20px;">
                    <h4>åœ°å›¾æœåŠ¡é…ç½®</h4>
                    <div style="margin-bottom: 10px;">
                        <label for="mapProvider">æœåŠ¡æä¾›å•†:</label>
                        <select id="mapProvider" style="margin-left: 10px; padding: 5px;">
                            <option value="none">æš‚ä¸ä½¿ç”¨</option>
                            <option value="amap">é«˜å¾·åœ°å›¾</option>
                            <option value="baidu">ç™¾åº¦åœ°å›¾</option>
                        </select>
                    </div>
                    <div id="mapApiConfig" style="display: none; margin-bottom: 15px;">
                        <label for="mapApiKey" style="display: inline-block; width: 100px;">API Key:</label>
                        <input type="text" id="mapApiKey" placeholder="è¯·è¾“å…¥åœ°å›¾ API Key" style="width: 300px; padding: 6px;">
                    </div>
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button id="saveApiKeysBtn" style="padding: 10px 25px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">ä¿å­˜é…ç½®</button>
                    <button id="testApiBtn" style="margin-left: 15px; padding: 10px 25px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">æµ‹è¯•è¿æ¥</button>
                </div>
                <div id="configMessage" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { mockAuth } from './firebase.js';
        import { aiService } from './ai-service.js';
        // è¯­éŸ³è¯†åˆ«åŠŸèƒ½ - æ”¯æŒæµè§ˆå™¨åŸç”Ÿå’Œç§‘å¤§è®¯é£ API
        async function startVoiceRecognition(elementId) {
            const voiceApiKey = localStorage.getItem('voiceApiKey');
            
            // å¦‚æœæœ‰ç§‘å¤§è®¯é£ API Keyï¼Œåˆ™ä½¿ç”¨ç§‘å¤§è®¯é£ API
            if (voiceApiKey && voiceApiKey.trim() !== '') {
                await startIflytekVoiceRecognition(elementId, voiceApiKey);
            } else {
                // å¦åˆ™ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿè¯­éŸ³è¯†åˆ«
                startBrowserVoiceRecognition(elementId);
            }
        }
        
        // æµè§ˆå™¨åŸç”Ÿè¯­éŸ³è¯†åˆ«
        function startBrowserVoiceRecognition(elementId) {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            
            // æ‰¾åˆ°å¯¹åº”çš„è¾“å…¥æ¡†å’ŒæŒ‰é’®
            const inputElement = document.getElementById(elementId);
            const voiceButton = inputElement?.nextElementSibling;
            
            if (voiceButton) {
                voiceButton.innerHTML = 'ğŸ¤ æ­£åœ¨è†å¬...';
                voiceButton.style.backgroundColor = '#e74c3c';
            }

            recognition.onstart = () => {
                console.log('è¯­éŸ³è¯†åˆ«å·²å¼€å§‹');
            };

            recognition.onresult = (event) => {
                const speechResult = event.results[0][0].transcript;
                inputElement.value = speechResult;
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                if (voiceButton) {
                    voiceButton.innerHTML = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    voiceButton.style.backgroundColor = '#2ecc71';
                }
            };

            recognition.onend = () => {
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                if (voiceButton) {
                    voiceButton.innerHTML = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    voiceButton.style.backgroundColor = '#2ecc71';
                }
            };

            recognition.onerror = (event) => {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                if (voiceButton) {
                    voiceButton.innerHTML = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    voiceButton.style.backgroundColor = '#2ecc71';
                }
            };

            recognition.start();
        }
        
        // ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ« API é›†æˆï¼ˆæ¨¡æ‹Ÿï¼‰
        async function startIflytekVoiceRecognition(elementId, apiKey) {
            try {
                const inputElement = document.getElementById(elementId);
                const voiceButton = inputElement?.nextElementSibling;
                
                if (voiceButton) {
                    voiceButton.innerHTML = 'ğŸ¤ ç§‘å¤§è®¯é£è¯†åˆ«ä¸­...';
                    voiceButton.style.backgroundColor = '#9b59b6';
                }
                
                // æ¨¡æ‹Ÿç§‘å¤§è®¯é£ API è°ƒç”¨å»¶è¿Ÿ
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // æ¨¡æ‹Ÿè¯­éŸ³è¯†åˆ«ç»“æœ
                const mockResults = [
                    'æˆ‘æƒ³å»æ—¥æœ¬ä¸œäº¬æ—…è¡Œ',
                    'äº”å¤©æ—¶é—´ï¼Œé¢„ç®—ä¸€ä¸‡å…ƒ',
                    'å–œæ¬¢ç¾é£Ÿå’Œè´­ç‰©',
                    'å¸¦ä¸¤ä¸ªå­©å­ä¸€èµ·æ—…è¡Œ'
                ];
                
                const randomResult = mockResults[Math.floor(Math.random() * mockResults.length)];
                inputElement.value = randomResult;
                
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                if (voiceButton) {
                    voiceButton.innerHTML = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    voiceButton.style.backgroundColor = '#2ecc71';
                }
                
                alert('ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«å®Œæˆ');
            } catch (error) {
                console.error('ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«é”™è¯¯:', error);
                alert('ç§‘å¤§è®¯é£è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Key');
            }
        }
        
        // æ·»åŠ è¯­éŸ³è¯†åˆ«åŠŸèƒ½åˆ°è´¹ç”¨ç®¡ç†éƒ¨åˆ†
        document.addEventListener('DOMContentLoaded', () => {
            // ä¸ºè´¹ç”¨é¡¹ç›®æ·»åŠ è¯­éŸ³è¾“å…¥æŒ‰é’®
            const expenseItemInput = document.getElementById('expenseItem');
            if (expenseItemInput) {
                const voiceButton = document.createElement('button');
                voiceButton.className = 'voice-button';
                voiceButton.textContent = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                voiceButton.onclick = () => startVoiceRecognition('expenseItem');
                expenseItemInput.parentNode.appendChild(voiceButton);
            }
        });

        // ç”Ÿæˆæ—…è¡Œè®¡åˆ’
        document.getElementById('planBtn').addEventListener('click', async () => {
            const destination = document.getElementById('destination').value;
            const days = document.getElementById('days').value;
            const budget = document.getElementById('budget').value;
            const travelers = document.getElementById('travelers').value || '2';
            const preferences = document.getElementById('preferences').value;

            if (!destination || !days || !budget) {
                alert('è¯·å¡«å†™å¿…è¦çš„æ—…è¡Œä¿¡æ¯ï¼ˆç›®çš„åœ°ã€å¤©æ•°å’Œé¢„ç®—ï¼‰');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const planBtn = document.getElementById('planBtn');
            const originalText = planBtn.textContent;
            planBtn.textContent = 'ç”Ÿæˆä¸­...';
            planBtn.disabled = true;

            try {
                // ä½¿ç”¨ AI æœåŠ¡ç”Ÿæˆæ—…è¡Œè®¡åˆ’
                const tripData = {
                    destination,
                    days: parseInt(days),
                    budget: parseInt(budget),
                    travelers: parseInt(travelers),
                    preferences
                };

                const planData = await aiService.generateTripPlan(tripData);
                
                // ä¿å­˜æ—…è¡Œè®¡åˆ’åˆ°æœ¬åœ°å­˜å‚¨
                if (mockAuth.currentUser) {
                    // è¿™é‡Œå¯ä»¥é›†æˆåˆ°çœŸå®çš„æ•°æ®åº“
                    console.log('ä¿å­˜æ—…è¡Œè®¡åˆ’:', planData);
                    // æ¨¡æ‹Ÿä¿å­˜
                    const savedPlans = JSON.parse(localStorage.getItem('savedPlans') || '[]');
                    savedPlans.push({
                        id: Date.now().toString(),
                        ...planData,
                        savedAt: new Date().toISOString()
                    });
                    localStorage.setItem('savedPlans', JSON.stringify(savedPlans));
                }

                displayPlan(planData);
            } catch (error) {
                console.error('ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥:', error);
                alert('ç”Ÿæˆæ—…è¡Œè®¡åˆ’å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚å¦‚æœæ‚¨ä½¿ç”¨çš„æ˜¯ API Keyï¼Œè¯·ç¡®ä¿å…¶æœ‰æ•ˆæ€§ã€‚');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                planBtn.textContent = originalText;
                planBtn.disabled = false;
            }
        });

        // æ˜¾ç¤ºæ—…è¡Œè®¡åˆ’
        function displayPlan(planData) {
            const planResult = document.getElementById('planResult');
            const planContent = document.getElementById('planContent');

            let html = `
                <h3>${planData.destination} - ${planData.days}å¤©æ—…è¡Œè®¡åˆ’</h3>
                <p>é¢„ç®—: ${planData.budget}å…ƒ | äººæ•°: ${planData.travelers}äºº</p>
                <p>åå¥½: ${planData.preferences}</p>
                ${planData.totalEstimatedCost ? `<p class="estimated-cost">é¢„è®¡æ€»è´¹ç”¨: <strong>${planData.totalEstimatedCost}å…ƒ</strong></p>` : ''}
                <hr>
            `;

            // äº¤é€šå»ºè®®
            if (planData.transportation) {
                html += `
                    <h4>äº¤é€šå»ºè®®</h4>
                    <p>${planData.transportation}</p>
                    <hr>
                `;
            }

            // æ¯æ—¥è¡Œç¨‹
            planData.plan.forEach(dayPlan => {
                html += `
                    <h4>ç¬¬${dayPlan.day}å¤© ${dayPlan.dailyBudget ? `- å½“æ—¥é¢„ç®—: ${dayPlan.dailyBudget}å…ƒ` : ''}</h4>
                    ${dayPlan.accommodation ? `<p class="accommodation">ğŸ¨ ä½å®¿: ${dayPlan.accommodation}</p>` : ''}
                    <ul class="activity-list">
                `;
                
                dayPlan.activities.forEach(activity => {
                    html += `
                        <li class="activity-item">
                            <strong class="activity-time">${activity.time}</strong>
                            <span class="activity-description">${activity.description}</span>
                            ${activity.location ? `<span class="activity-location">ğŸ“ ${activity.location}</span>` : ''}
                            ${activity.estimatedCost ? `<span class="activity-cost">ğŸ’° ${activity.estimatedCost}å…ƒ</span>` : ''}
                        </li>
                    `;
                });
                
                html += `</ul><hr>`;
            });

            // æ—…è¡Œæç¤º
            if (planData.tips && planData.tips.length > 0) {
                html += `
                    <h4>æ—…è¡Œæç¤º</h4>
                    <ul class="tips-list">
                `;
                planData.tips.forEach(tip => {
                    html += `<li class="tip-item">ğŸ’¡ ${tip}</li>`;
                });
                html += `</ul>`;
            }

            planContent.innerHTML = html;
            planResult.style.display = 'block';
            
            // æ·»åŠ ä¸€äº›æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .activity-list {
                    list-style: none;
                    padding: 0;
                }
                .activity-item {
                    padding: 10px;
                    margin-bottom: 8px;
                    background-color: #f8f9fa;
                    border-radius: 6px;
                    display: flex;
                    flex-direction: column;
                }
                .activity-time {
                    color: #3498db;
                    font-size: 18px;
                }
                .activity-description {
                    font-weight: 500;
                    margin: 5px 0;
                }
                .activity-location, .activity-cost {
                    font-size: 14px;
                    color: #666;
                    margin-top: 3px;
                }
                .accommodation {
                    background-color: #e3f2fd;
                    padding: 8px;
                    border-radius: 4px;
                    font-weight: 500;
                }
                .tips-list {
                    list-style: none;
                    padding: 0;
                }
                .tip-item {
                    padding: 8px;
                    margin-bottom: 5px;
                    background-color: #fff3cd;
                    border-radius: 4px;
                }
                .estimated-cost {
                    font-size: 18px;
                    color: #e74c3c;
                }
            `;
            document.head.appendChild(style);
            
            // åœ¨åœ°å›¾ä¸Šæ ‡è®°è¡Œç¨‹è·¯çº¿
            if (window.mapService) {
                mapService.markTripRoute(planData).catch(error => {
                    console.error('åœ°å›¾æ ‡è®°å¤±è´¥:', error);
                });
            } else {
                console.log('åœ°å›¾æœåŠ¡æœªåŠ è½½ï¼Œæ— æ³•æ ‡è®°è¡Œç¨‹è·¯çº¿');
            }
        }

        // æ·»åŠ è´¹ç”¨
        document.getElementById('addExpenseBtn').addEventListener('click', () => {
            const item = document.getElementById('expenseItem').value;
            const amount = document.getElementById('expenseAmount').value;

            if (!item || !amount) {
                alert('è¯·å¡«å†™è´¹ç”¨ä¿¡æ¯');
                return;
            }

            const expenseList = document.getElementById('expenseList');
            const expenseItem = document.createElement('div');
            expenseItem.className = 'budget-item';
            expenseItem.innerHTML = `
                <span>${item}</span>
                <span>Â¥${amount}</span>
            `;
            expenseList.appendChild(expenseItem);

            // æ¸…ç©ºè¾“å…¥
            document.getElementById('expenseItem').value = '';
            document.getElementById('expenseAmount').value = '';
        });

        // API é…ç½®ç›¸å…³åŠŸèƒ½
        function initApiConfig() {
            // åŠ è½½ä¿å­˜çš„é…ç½®
            const savedConfig = JSON.parse(localStorage.getItem('apiConfig') || '{}');
            
            // è®¾ç½®é€‰æ‹©å™¨çš„å€¼
            if (savedConfig.aiProvider) document.getElementById('aiProvider').value = savedConfig.aiProvider;
            if (savedConfig.voiceProvider) document.getElementById('voiceProvider').value = savedConfig.voiceProvider;
            if (savedConfig.mapProvider) document.getElementById('mapProvider').value = savedConfig.mapProvider;
            
            // è®¾ç½® API Keyï¼ˆæ³¨æ„ï¼šå¯†ç å­—æ®µä¸è‡ªåŠ¨å¡«å……ä»¥ä¿æŠ¤å®‰å…¨ï¼‰
            // è®¾ç½®å…¶ä»–é…ç½®
            if (savedConfig.openaiModel) document.getElementById('openaiModel').value = savedConfig.openaiModel;
            if (savedConfig.aliyunModel) document.getElementById('aliyunModel').value = savedConfig.aliyunModel;
            
            // å¤„ç†æœåŠ¡æä¾›å•†åˆ‡æ¢
            document.getElementById('aiProvider').addEventListener('change', updateAIConfigVisibility);
            document.getElementById('voiceProvider').addEventListener('change', updateVoiceConfigVisibility);
            document.getElementById('mapProvider').addEventListener('change', updateMapConfigVisibility);
            
            // åˆå§‹æ›´æ–°å¯è§æ€§
            updateAIConfigVisibility();
            updateVoiceConfigVisibility();
            updateMapConfigVisibility();
            
            // ä¿å­˜é…ç½®æŒ‰é’®äº‹ä»¶
            document.getElementById('saveApiKeysBtn').addEventListener('click', saveConfig);
            
            // æµ‹è¯•è¿æ¥æŒ‰é’®äº‹ä»¶
            document.getElementById('testApiBtn').addEventListener('click', testConnection);
        }
        
        function updateAIConfigVisibility() {
            const provider = document.getElementById('aiProvider').value;
            document.getElementById('openaiConfig').style.display = provider === 'openai' ? 'block' : 'none';
            document.getElementById('aliyunConfig').style.display = provider === 'aliyun' ? 'block' : 'none';
            // æ ¹æ®ä¸åŒæä¾›å•†è°ƒæ•´ API Key æ ‡ç­¾å’Œæ˜¾ç¤ºé€‰é¡¹
        const apiKeyLabel = provider === 'openai' ? 'API Key:' :
            provider === 'aliyun' ? 'Access Key:' : 'API Key:';
        document.querySelector('label[for="aiApiKey"]').textContent = apiKeyLabel;
        
        // æ›´æ–°æ¨¡å‹åˆ—è¡¨
        if (provider === 'openai' || provider === 'aliyun') {
            const modelSelect = provider === 'openai' ? document.getElementById('openaiModel') : document.getElementById('aliyunModel');
            // æ¸…ç©ºç°æœ‰é€‰é¡¹
            modelSelect.innerHTML = '';
            
            // è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
            const models = aiService.getAvailableModels();
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                modelSelect.appendChild(option);
            });
        }
        }
        
        function updateVoiceConfigVisibility() {
            const provider = document.getElementById('voiceProvider').value;
            document.getElementById('iflytekConfig').style.display = provider === 'iflytek' ? 'block' : 'none';
        }
        
        function updateMapConfigVisibility() {
            const provider = document.getElementById('mapProvider').value;
            document.getElementById('mapApiConfig').style.display = provider !== 'none' ? 'block' : 'none';
        }
        
        function saveConfig() {
            const config = {
                aiProvider: document.getElementById('aiProvider').value,
                voiceProvider: document.getElementById('voiceProvider').value,
                mapProvider: document.getElementById('mapProvider').value,
                openaiModel: document.getElementById('openaiModel').value,
                aliyunModel: document.getElementById('aliyunModel').value
            };
            
            // ä¿å­˜æ•æ„Ÿä¿¡æ¯
            const aiApiKey = document.getElementById('aiApiKey').value;
            const voiceApiKey = document.getElementById('voiceApiKey').value;
            const voiceApiSecret = document.getElementById('voiceApiSecret').value;
            const mapApiKey = document.getElementById('mapApiKey').value;
            const aliyunAppKey = document.getElementById('aliyunAppKey').value;
            
            // ä¿å­˜åˆ° localStorage
            if (aiApiKey) localStorage.setItem('aiApiKey', aiApiKey);
            if (voiceApiKey) localStorage.setItem('voiceApiKey', voiceApiKey);
            if (voiceApiSecret) localStorage.setItem('voiceApiSecret', voiceApiSecret);
            if (mapApiKey) localStorage.setItem('mapApiKey', mapApiKey);
            if (aliyunAppKey) localStorage.setItem('aliyunAppKey', aliyunAppKey);
            
            // æ›´æ–° AI æœåŠ¡é…ç½®
            const aiConfig = {
                apiKey: aiApiKey,
                provider: config.aiProvider,
                modelName: config.aiProvider === 'openai' ? config.openaiModel : config.aliyunModel,
                aliyunAppKey: aliyunAppKey
            };
            aiService.updateConfig(aiConfig);
            
            // ä¿å­˜é…ç½®
            localStorage.setItem('apiConfig', JSON.stringify(config));
            
            showConfigMessage('é…ç½®å·²æˆåŠŸä¿å­˜ï¼', 'success');
        }
        
        async function testConnection() {
            const configMessage = document.getElementById('configMessage');
            configMessage.textContent = 'æ­£åœ¨æµ‹è¯•è¿æ¥...';
            configMessage.className = 'testing';
            configMessage.style.display = 'block';
            configMessage.style.backgroundColor = '#e3f2fd';
            configMessage.style.color = '#1976d2';
            
            try {
                // è·å–å½“å‰é…ç½®
                const aiConfig = {
                    apiKey: document.getElementById('aiApiKey').value,
                    provider: document.getElementById('aiProvider').value,
                    modelName: document.getElementById('aiProvider').value === 'openai' ? 
                        document.getElementById('openaiModel').value : 
                        document.getElementById('aliyunModel').value,
                    aliyunAppKey: document.getElementById('aliyunAppKey').value
                };
                
                // å¦‚æœæœ‰ API Keyï¼Œå…ˆæ›´æ–°é…ç½®
                if (aiConfig.apiKey) {
                    aiService.updateConfig(aiConfig);
                }
                
                // è°ƒç”¨ AI æœåŠ¡çš„æµ‹è¯•è¿æ¥æ–¹æ³•
                const result = await aiService.testConnection();
                
                if (result.success) {
                    showConfigMessage(result.message, 'success');
                } else {
                    showConfigMessage('è¿æ¥æµ‹è¯•å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                showConfigMessage('æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }
        
        function showConfigMessage(message, type) {
            const configMessage = document.getElementById('configMessage');
            configMessage.textContent = message;
            configMessage.style.display = 'block';
            
            if (type === 'success') {
                configMessage.style.backgroundColor = '#d4edda';
                configMessage.style.color = '#155724';
            } else if (type === 'error') {
                configMessage.style.backgroundColor = '#f8d7da';
                configMessage.style.color = '#721c24';
            }
            
            // 3ç§’åè‡ªåŠ¨éšè—æ¶ˆæ¯
            setTimeout(() => {
                configMessage.style.display = 'none';
            }, 3000);
        }
        
        // åˆå§‹åŒ– API é…ç½®
        initApiConfig();

        // é¡µé¢åŠ è½½æ—¶ä» localStorage è¯»å– API Key å’Œç”¨æˆ·è®¤è¯çŠ¶æ€
        window.addEventListener('load', () => {
            const aiApiKey = localStorage.getItem('aiApiKey');
            const voiceApiKey = localStorage.getItem('voiceApiKey');
            const mapApiKey = localStorage.getItem('mapApiKey');

            if (aiApiKey) document.getElementById('aiApiKey').value = aiApiKey;
            if (voiceApiKey) document.getElementById('voiceApiKey').value = voiceApiKey;
            if (mapApiKey) document.getElementById('mapApiKey').value = mapApiKey;
            
            // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
            checkAuthStatus();
        });
        
        // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
        function checkAuthStatus() {
            const user = mockAuth.checkAuth();
            updateUIForAuth(user);
        }
        
        // æ›´æ–° UI ä»¥åæ˜ è®¤è¯çŠ¶æ€
        function updateUIForAuth(user) {
            const authSection = document.querySelector('.auth-section');
            const inputSection = document.querySelector('.input-section');
            const budgetSection = document.querySelector('.budget-section');
            
            if (user) {
                // ç”¨æˆ·å·²ç™»å½•
                authSection.innerHTML = `
                    <h2>å·²ç™»å½•</h2>
                    <p>æ¬¢è¿ï¼Œ${user.email}</p>
                    <button id="logoutBtn">é€€å‡ºç™»å½•</button>
                `;
                
                // å¯ç”¨åŠŸèƒ½åŒºåŸŸ
                inputSection.style.display = 'block';
                budgetSection.style.display = 'block';
                
                // æ·»åŠ é€€å‡ºç™»å½•äº‹ä»¶ç›‘å¬å™¨
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    await mockAuth.logout();
                    checkAuthStatus();
                });
                
                // åŠ è½½ä¿å­˜çš„æ—…è¡Œè®¡åˆ’
                loadSavedTripPlans();
            } else {
                // ç”¨æˆ·æœªç™»å½•
                authSection.innerHTML = `
                    <h2>ç”¨æˆ·ç™»å½•/æ³¨å†Œ</h2>
                    <div class="form-group">
                        <label for="email">é‚®ç®±</label>
                        <input type="email" id="email" placeholder="è¯·è¾“å…¥é‚®ç®±">
                    </div>
                    <div class="form-group">
                        <label for="password">å¯†ç </label>
                        <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç ">
                    </div>
                    <button id="loginBtn">ç™»å½•</button>
                    <button id="registerBtn">æ³¨å†Œ</button>
                `;
                
                // ç¦ç”¨åŠŸèƒ½åŒºåŸŸ
                inputSection.style.display = 'none';
                budgetSection.style.display = 'none';
                
                // æ·»åŠ ç™»å½•å’Œæ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
                document.getElementById('loginBtn').addEventListener('click', handleLogin);
                document.getElementById('registerBtn').addEventListener('click', handleRegister);
            }
        }
        
        // å¤„ç†ç™»å½•
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const result = await mockAuth.login(email, password);
            if (result.success) {
                alert('ç™»å½•æˆåŠŸï¼');
                checkAuthStatus();
            } else {
                alert('ç™»å½•å¤±è´¥ï¼š' + result.error);
            }
        }
        
        // å¤„ç†æ³¨å†Œ
        async function handleRegister() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            const result = await mockAuth.register(email, password);
            if (result.success) {
                alert('æ³¨å†ŒæˆåŠŸï¼');
                checkAuthStatus();
            } else {
                alert('æ³¨å†Œå¤±è´¥ï¼š' + result.error);
            }
        }
        
        // åŠ è½½ä¿å­˜çš„æ—…è¡Œè®¡åˆ’
        async function loadSavedTripPlans() {
            // è¿™é‡Œä¼šé›†æˆä»æ•°æ®åº“åŠ è½½æ—…è¡Œè®¡åˆ’çš„é€»è¾‘
            console.log('åŠ è½½ä¿å­˜çš„æ—…è¡Œè®¡åˆ’...');
        }
        
        // è´¹ç”¨é¢„ç®—ä¸ç®¡ç†åŠŸèƒ½
        // åˆå§‹åŒ–è´¹ç”¨ç®¡ç†
        function initExpenseManagement() {
            // è®¾ç½®è´¹ç”¨è®°å½•é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            const expenseDateEl = document.getElementById('expenseDate');
            if (expenseDateEl) {
                expenseDateEl.value = new Date().toISOString().split('T')[0];
            }
            
            // åŠ è½½ä¿å­˜çš„è´¹ç”¨è®°å½•
            loadExpenses();
            
            // ç»‘å®šæ·»åŠ è´¹ç”¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const addExpenseBtn = document.getElementById('addExpenseBtn');
            if (addExpenseBtn) {
                // å…ˆç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                const newAddExpenseBtn = addExpenseBtn.cloneNode(true);
                addExpenseBtn.parentNode.replaceChild(newAddExpenseBtn, addExpenseBtn);
                newAddExpenseBtn.addEventListener('click', addExpense);
            }
            
            // ç»‘å®šè¯­éŸ³è¾“å…¥è´¹ç”¨æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const voiceExpenseBtn = document.getElementById('voiceExpenseBtn');
            if (voiceExpenseBtn) {
                voiceExpenseBtn.addEventListener('click', voiceInputExpense);
            }
        }
        
        // åŠ è½½è´¹ç”¨è®°å½•
        function loadExpenses() {
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            const currentTrip = JSON.parse(localStorage.getItem('currentTrip') || 'null');
            
            if (currentTrip) {
                updateBudgetInfo(currentTrip.budget);
            }
            
            if (expenses.length > 0) {
                renderExpenseList(expenses);
                calculateBudgetAnalysis(expenses, currentTrip?.budget || 0);
            }
        }
        
        // æ›´æ–°é¢„ç®—ä¿¡æ¯
        function updateBudgetInfo(budget) {
            const totalBudgetEl = document.getElementById('totalBudget');
            if (totalBudgetEl) {
                totalBudgetEl.textContent = budget;
            }
            
            // é‡æ–°è®¡ç®—é¢„ç®—åˆ†æ
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            calculateBudgetAnalysis(expenses, budget);
        }
        
        // æ·»åŠ è´¹ç”¨è®°å½•
        function addExpense() {
            const category = document.getElementById('expenseCategory')?.value;
            const amount = parseFloat(document.getElementById('expenseAmount')?.value);
            const date = document.getElementById('expenseDate')?.value;
            const description = document.getElementById('expenseDescription')?.value;
            
            // éªŒè¯è¾“å…¥
            if (!amount || amount <= 0) {
                showExpenseMessage('è¯·è¾“å…¥æœ‰æ•ˆé‡‘é¢', 'error');
                return;
            }
            
            if (!date) {
                showExpenseMessage('è¯·é€‰æ‹©æ—¥æœŸ', 'error');
                return;
            }
            
            // åˆ›å»ºè´¹ç”¨è®°å½•
            const expense = {
                id: Date.now().toString(),
                category,
                amount,
                date,
                description,
                createdAt: new Date().toISOString()
            };
            
            // ä¿å­˜åˆ°localStorage
            const expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
            expenses.push(expense);
            localStorage.setItem('expenses', JSON.stringify(expenses));
            
            // æ›´æ–°UI
            renderExpenseList(expenses);
            
            // æ›´æ–°é¢„ç®—åˆ†æ
            const currentTrip = JSON.parse(localStorage.getItem('currentTrip') || 'null');
            calculateBudgetAnalysis(expenses, currentTrip?.budget || 0);
            
            // é‡ç½®è¡¨å•
            if (document.getElementById('expenseAmount')) {
                document.getElementById('expenseAmount').value = '';
            }
            if (document.getElementById('expenseDescription')) {
                document.getElementById('expenseDescription').value = '';
            }
            
            showExpenseMessage('è´¹ç”¨è®°å½•å·²æ·»åŠ ', 'success');
        }
        
        // æ¸²æŸ“è´¹ç”¨åˆ—è¡¨
        function renderExpenseList(expenses) {
            const expenseList = document.getElementById('expenseList');
            if (!expenseList) return;
            
            if (expenses.length === 0) {
                expenseList.innerHTML = '<p style="color: #666; text-align: center;">æš‚æ— è´¹ç”¨è®°å½•</p>';
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼Œæœ€æ–°çš„åœ¨å‰é¢
            const sortedExpenses = expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            sortedExpenses.forEach(expense => {
                html += `
                    <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="background-color: #${getCategoryColor(expense.category)}20; color: #${getCategoryColor(expense.category)}; padding: 2px 8px; border-radius: 12px; font-size: 12px;">${expense.category}</span>
                                <span>${formatDate(expense.date)}</span>
                            </div>
                            <p style="margin: 5px 0; font-size: 14px;">${expense.description || 'æ— æè¿°'}</p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-weight: bold; font-size: 16px;">${expense.amount} å…ƒ</span>
                            <button onclick="deleteExpense('${expense.id}')" style="background-color: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                `;
            });
            
            expenseList.innerHTML = html;
        }
        
        // åˆ é™¤è´¹ç”¨è®°å½•
        window.deleteExpense = function(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è´¹ç”¨è®°å½•å—ï¼Ÿ')) {
                let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
                expenses = expenses.filter(expense => expense.id !== id);
                localStorage.setItem('expenses', JSON.stringify(expenses));
                
                renderExpenseList(expenses);
                
                // æ›´æ–°é¢„ç®—åˆ†æ
                const currentTrip = JSON.parse(localStorage.getItem('currentTrip') || 'null');
                calculateBudgetAnalysis(expenses, currentTrip?.budget || 0);
            }
        };
        
        // è®¡ç®—é¢„ç®—åˆ†æ
        function calculateBudgetAnalysis(expenses, budget) {
            // å¦‚æœæœ‰è¡Œç¨‹è®¡åˆ’ï¼Œåˆ™ä½¿ç”¨aiServiceè¿›è¡Œåˆ†æ
            if (window.aiService && budget > 0) {
                aiService.analyzeBudget({ budget }, expenses)
                    .then(analysis => {
                        renderBudgetAnalysis(analysis);
                    })
                    .catch(error => {
                        console.error('é¢„ç®—åˆ†æå¤±è´¥:', error);
                    });
            }
        }
        
        // æ¸²æŸ“é¢„ç®—åˆ†æ
        function renderBudgetAnalysis(analysis) {
            // æ›´æ–°åŸºç¡€ä¿¡æ¯
            const totalExpensesEl = document.getElementById('totalExpenses');
            const percentageUsedEl = document.getElementById('percentageUsed');
            const remainingBudgetEl = document.getElementById('remainingBudget');
            const budgetStatusEl = document.getElementById('budgetStatus');
            const budgetProgressBarEl = document.getElementById('budgetProgressBar');
            const categoriesEl = document.getElementById('expenseCategories');
            const recommendationsEl = document.getElementById('budgetRecommendations');
            
            if (totalExpensesEl) totalExpensesEl.textContent = analysis.totalExpenses;
            if (percentageUsedEl) percentageUsedEl.textContent = analysis.percentageUsed.toFixed(1);
            if (remainingBudgetEl) remainingBudgetEl.textContent = analysis.remainingBudget;
            if (budgetStatusEl) budgetStatusEl.textContent = analysis.budgetStatus;
            
            // æ›´æ–°é¢„ç®—çŠ¶æ€æ ·å¼
            if (budgetStatusEl) {
                budgetStatusEl.className = '';
                if (analysis.percentageUsed > 90) {
                    budgetStatusEl.style.color = '#f44336';
                } else if (analysis.percentageUsed > 70) {
                    budgetStatusEl.style.color = '#ff9800';
                } else {
                    budgetStatusEl.style.color = '#4CAF50';
                }
            }
            
            // æ›´æ–°è¿›åº¦æ¡
            if (budgetProgressBarEl) {
                budgetProgressBarEl.style.width = `${Math.min(analysis.percentageUsed, 100)}%`;
                if (analysis.percentageUsed > 90) {
                    budgetProgressBarEl.style.backgroundColor = '#f44336';
                } else if (analysis.percentageUsed > 70) {
                    budgetProgressBarEl.style.backgroundColor = '#ff9800';
                } else {
                    budgetProgressBarEl.style.backgroundColor = '#4CAF50';
                }
            }
            
            // æ¸²æŸ“æ”¯å‡ºåˆ†ç±»
            if (categoriesEl) {
                if (Object.keys(analysis.expenseCategories).length > 0) {
                    let categoriesHtml = '';
                    Object.entries(analysis.expenseCategories).forEach(([category, amount]) => {
                        const percentage = ((amount / analysis.totalExpenses) * 100).toFixed(1);
                        categoriesHtml += `
                            <div style="background-color: #${getCategoryColor(category)}20; padding: 8px; border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>${category}</span>
                                    <span><strong>${amount} å…ƒ</strong> (${percentage}%)</span>
                                </div>
                            </div>
                        `;
                    });
                    categoriesEl.innerHTML = categoriesHtml;
                } else {
                    categoriesEl.innerHTML = '<p style="color: #666;">æš‚æ— æ”¯å‡ºæ•°æ®</p>';
                }
            }
            
            // æ¸²æŸ“å»ºè®®
            if (recommendationsEl) {
                if (analysis.recommendations && analysis.recommendations.length > 0) {
                    let recommendationsHtml = '';
                    analysis.recommendations.forEach(rec => {
                        recommendationsHtml += `<li style="margin-bottom: 5px; padding-left: 20px; position: relative;">
                            <span style="position: absolute; left: 0; color: #4CAF50;">â€¢</span>
                            ${rec}
                        </li>`;
                    });
                    recommendationsEl.innerHTML = recommendationsHtml;
                }
            }
        }
        
        // è¯­éŸ³è¾“å…¥è´¹ç”¨
        function voiceInputExpense() {
            if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                showExpenseMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½', 'error');
                return;
            }
            
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'zh-CN';
            recognition.interimResults = false;
            
            showExpenseMessage('è¯·è¯´å‡ºè´¹ç”¨ä¿¡æ¯ï¼Œä¾‹å¦‚ï¼š"é¤é¥®ï¼Œåˆé¤ï¼Œ100å…ƒï¼Œ2024-01-15"', 'info');
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('è¯­éŸ³è¯†åˆ«ç»“æœ:', transcript);
                
                // è§£æè¯­éŸ³è¾“å…¥
                parseVoiceExpenseInput(transcript);
            };
            
            recognition.onerror = function(event) {
                showExpenseMessage('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
            };
            
            recognition.start();
        }
        
        // è§£æè¯­éŸ³è¾“å…¥çš„è´¹ç”¨ä¿¡æ¯
        function parseVoiceExpenseInput(text) {
            try {
                // ç®€å•çš„è§£æé€»è¾‘
                const categoryMap = {
                    'é¤é¥®': ['é¤é¥®', 'åƒé¥­', 'åˆé¤', 'æ™šé¤', 'æ—©é¤', 'é¥­', 'é¤'],
                    'äº¤é€š': ['äº¤é€š', 'æ‰“è½¦', 'å…¬äº¤', 'åœ°é“', 'ç«è½¦', 'é£æœº'],
                    'ä½å®¿': ['ä½å®¿', 'é…’åº—', 'å®¾é¦†'],
                    'è´­ç‰©': ['è´­ç‰©', 'ä¹°', 'å•†å“'],
                    'æ™¯ç‚¹': ['æ™¯ç‚¹', 'é—¨ç¥¨', 'å‚è§‚'],
                    'å…¶ä»–': ['å…¶ä»–']
                };
                
                let category = 'å…¶ä»–';
                let amount = 0;
                let description = '';
                
                // æå–é‡‘é¢
                const amountMatch = text.match(/(\d+)å…ƒ/);
                if (amountMatch) {
                    amount = parseFloat(amountMatch[1]);
                }
                
                // æå–ç±»åˆ«
                for (const [key, values] of Object.entries(categoryMap)) {
                    for (const value of values) {
                        if (text.includes(value)) {
                            category = key;
                            // æå–æè¿°
                            const parts = text.split(value);
                            if (parts.length > 1) {
                                description = parts[1].replace(/\d+å…ƒ/g, '').trim();
                            }
                            break;
                        }
                    }
                }
                
                // å¡«å……è¡¨å•
                if (category && document.getElementById('expenseCategory')) {
                    document.getElementById('expenseCategory').value = category;
                }
                if (amount && document.getElementById('expenseAmount')) {
                    document.getElementById('expenseAmount').value = amount;
                }
                if (description && document.getElementById('expenseDescription')) {
                    document.getElementById('expenseDescription').value = description;
                }
                
                showExpenseMessage('è¯­éŸ³è¾“å…¥å·²è¯†åˆ«ï¼Œè¯·ç¡®è®¤ä¿¡æ¯æ— è¯¯åç‚¹å‡»æ·»åŠ ', 'success');
            } catch (error) {
                showExpenseMessage('æ— æ³•è§£æè¯­éŸ³è¾“å…¥ï¼Œè¯·å°è¯•å…¶ä»–æ ¼å¼', 'error');
            }
        }
        
        // æ˜¾ç¤ºè´¹ç”¨ç›¸å…³æ¶ˆæ¯
        function showExpenseMessage(message, type) {
            const messageEl = document.getElementById('expenseMessage');
            if (!messageEl) return;
            
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            // è®¾ç½®æ ·å¼
            if (type === 'success') {
                messageEl.style.backgroundColor = '#d4edda';
                messageEl.style.color = '#155724';
            } else if (type === 'error') {
                messageEl.style.backgroundColor = '#f8d7da';
                messageEl.style.color = '#721c24';
            } else if (type === 'info') {
                messageEl.style.backgroundColor = '#d1ecf1';
                messageEl.style.color = '#0c5460';
            }
            
            // 3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
        
        // è·å–ç±»åˆ«å¯¹åº”çš„é¢œè‰²
        function getCategoryColor(category) {
            const colors = {
                'é¤é¥®': 'FF6B6B',
                'äº¤é€š': '4ECDC4',
                'ä½å®¿': '45B7D1',
                'è´­ç‰©': '96CEB4',
                'æ™¯ç‚¹': 'FFEAA7',
                'å…¶ä»–': 'DDA0DD'
            };
            return colors[category] || 'CCCCCC';
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }
        
        // ä¿å­˜è¡Œç¨‹è®¡åˆ’æ—¶æ›´æ–°é¢„ç®—ä¿¡æ¯
        function saveTripPlan(plan) {
            // è¿™é‡Œå®ç°è¡Œç¨‹è®¡åˆ’çš„ä¿å­˜é€»è¾‘
            const savedPlans = JSON.parse(localStorage.getItem('savedTripPlans') || '[]');
            savedPlans.push({
                id: Date.now().toString(),
                name: `${plan.destination} - ${new Date().toLocaleDateString()}`,
                plan: plan,
                savedAt: new Date().toISOString()
            });
            localStorage.setItem('savedTripPlans', JSON.stringify(savedPlans));
            alert('è¡Œç¨‹è®¡åˆ’å·²ä¿å­˜ï¼');
            
            // æ›´æ–°é¢„ç®—ä¿¡æ¯
            updateBudgetInfo(plan.budget);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è´¹ç”¨ç®¡ç†
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initExpenseManagement);
        } else {
            initExpenseManagement();
        }
    </script>
</body>
</html>